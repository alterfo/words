"use strict";var ApplicationConfiguration=function(){var t="mean",e=["ui.router","ui.utils","ui.bootstrap","monospaced.elastic"],n=function(e,n){angular.module(e,n||[]),angular.module(t).requires.push(e)};return{applicationModuleName:t,applicationModuleVendorDependencies:e,registerModule:n}}();(function(){angular.module(ApplicationConfiguration.applicationModuleName,ApplicationConfiguration.applicationModuleVendorDependencies),angular.module(ApplicationConfiguration.applicationModuleName).config(["$locationProvider",function(t){t.hashPrefix("!")}]),angular.element(document).ready(function(){"#_=_"===window.location.hash&&(window.location.hash="#!"),angular.bootstrap(document,[ApplicationConfiguration.applicationModuleName])})}).call(this),function(){ApplicationConfiguration.registerModule("texts")}.call(this),function(){angular.module("texts").config(["$stateProvider","$urlRouterProvider",function(t,e){return t.state("today",{url:"/today",templateUrl:"modules/texts/main-views/today/today.view.html",controller:"todayCtrl",access:{restricted:!0}}).state("history",{url:"/history/:date",templateUrl:"modules/texts/main-views/history/history.view.html",access:{restricted:!0}}),e.otherwise("/signin")}])}.call(this),ApplicationConfiguration.registerModule("users"),function(){angular.module("texts").directive("authHide",["AuthService",function(t){return{restrict:"A",link:function(e,n,r){return e.user=t.getUser(),e.$watch(e.user,function(t,r){return e.user?n.addClass("ng-hide"):n.removeClass("ng-hide")})}}}]).directive("authShow",["AuthService",function(t){return{restrict:"A",link:function(e,n,r){return e.user=t.getUser(),e.$watch(e.user,function(t,r){return e.user?n.removeClass("ng-hide"):n.addClass("ng-hide")})}}}])}.call(this),function(){angular.module("texts").directive("authShow",["AuthService",function(t){return{restrict:"A",link:function(e,n,r){return e.user=t.getUser(),e.$watch(e.user,function(t,r){return e.user?n.removeClass("ng-hide"):n.addClass("ng-hide")})}}}])}.call(this),function(){}.call(this),function(){Date.prototype.yyyymm=function(){var t,e;return e=this.getFullYear().toString(),t=(this.getMonth()+1).toString(),e+"-"+(2===t.length?t:"0"+t)},Date.prototype.yyyymmdd=function(){var t,e,n;return n=this.getFullYear().toString(),e=(this.getMonth()+1).toString(),t=this.getDate().toString(),n+"-"+(2===e.length?e:"0"+e)+"-"+(2===t.length?t:"0"+t)},Date.prototype.nextMonth=function(){return new Date(this.setMonth(this.getMonth()+1))},Date.prototype.prevMonth=function(){return new Date(this.setMonth(this.getMonth()-1))},String.prototype.yyyymmToDate=function(){return new Date(this.slice(0,4),+this.slice(5,7)-1)},Date.prototype.isCurrentMonth=function(){var t,e,n,r,o,i;return i=this,r=new Date,o=r.getFullYear(),e=i.getFullYear(),n=r.getMonth(),t=i.getMonth(),n===t&&o===e},Date.prototype.daysInMonth=function(){return new Date(this.getFullYear(),this.getMonth()+1,0).getDate()},Date.prototype.isLessThenCurrentMonth=function(){var t;return t=new Date,t.setMonth(t.getMonth()-1),Date.parse(t)>Date.parse(this)}}.call(this),function(){angular.module("texts").factory("DateService",[function(){var t;return new(t=function(){function t(){this.today=new Date}return t.prototype.today=null,t.prototype.working_date=null,t.prototype.getToday=function(){return this.today},t.prototype.getTodayString=function(){return this.today.yyyymmdd()},t.prototype.getTodayDayNumber=function(){return this.today.getDate()},t.prototype.getTodayDayString=function(){var t;return t=this.today.getDate().toString(),2===t.length?t:"0"+t},t.prototype.getTodayMonthString=function(){return this.today.yyyymm()},t.prototype.daysInMonth=function(t,e){return new Date(e,t+1,0).getDate()},t.prototype.nextMonthString=function(t){return new Date(t.setMonth(t.getMonth()+1)).yyyymm()},t.prototype.prevMonthString=function(t){return new Date(t.setMonth(t.getMonth()-1)).yyyymm()},t}())}])}.call(this),angular.module("texts").service("Menus",[function(){this.defaultRoles=["*"],this.menus={};var t=function(t){if(!t)return this.isPublic;if(~this.roles.indexOf("*"))return!0;for(var e in t.roles)for(var n in this.roles)if(this.roles[n]===t.roles[e])return!0;return!1};this.validateMenuExistance=function(t){if(t&&t.length){if(this.menus[t])return!0;throw new Error("Menu does not exists")}throw new Error("MenuId was not provided")},this.getMenu=function(t){return this.validateMenuExistance(t),this.menus[t]},this.addMenu=function(e,n,r){return this.menus[e]={isPublic:n||!1,roles:r||this.defaultRoles,items:[],shouldRender:t},this.menus[e]},this.removeMenu=function(t){this.validateMenuExistance(t),delete this.menus[t]},this.addMenuItem=function(e,n,r,o,i,s,u,a){return this.validateMenuExistance(e),this.menus[e].items.push({title:n,link:r,menuItemType:o||"item",menuItemClass:o,uiRoute:i||"/"+r,isPublic:null===s||"undefined"==typeof s?this.menus[e].isPublic:s,roles:null===u||"undefined"==typeof u?this.menus[e].roles:u,position:a||0,items:[],shouldRender:t}),this.menus[e]},this.addSubMenuItem=function(e,n,r,o,i,s,u,a){this.validateMenuExistance(e);for(var c in this.menus[e].items)this.menus[e].items[c].link===n&&this.menus[e].items[c].items.push({title:r,link:o,uiRoute:i||"/"+o,isPublic:null===s||"undefined"==typeof s?this.menus[e].items[c].isPublic:s,roles:null===u||"undefined"==typeof u?this.menus[e].items[c].roles:u,position:a||0,shouldRender:t});return this.menus[e]},this.removeMenuItem=function(t,e){this.validateMenuExistance(t);for(var n in this.menus[t].items)this.menus[t].items[n].link===e&&this.menus[t].items.splice(n,1);return this.menus[t]},this.removeSubMenuItem=function(t,e){this.validateMenuExistance(t);for(var n in this.menus[t].items)for(var r in this.menus[t].items[n].items)this.menus[t].items[n].items[r].link===e&&this.menus[t].items[n].items.splice(r,1);return this.menus[t]},this.addMenu("topbar")}]),function(){}.call(this),function(){angular.module("texts").factory("WebApiService",["$http","$q",function(t,e){var n;return new(n=function(){function n(){}return n.prototype.timelineCache=[],n.prototype.getToday=function(){return t.get("/today")},n.prototype.getText=function(e){return t.get("/text/"+e)},n.prototype.fetchTimeline=function(n,r){var o,i,s,u,a;return s=e.defer(),this.timelineCache[n]?(r&&r(this.timelineCache[n]),s.resolve(),s.promise):(a=n.yyyymmToDate(),u=new Date,i=a.daysInMonth(),o=function(){var t,e,n;for(n=[],t=1,e=i-1;e>=1?e>=t:t>=e;e>=1?t++:t--)n.push("--");return n}(),t.get("/texts/"+n).then(function(t){return function(e){var c,l;return a.isCurrentMonth()&&(c=u.getDate()),a.isLessThenCurrentMonth()&&(c=i),c&&([].splice.apply(o,[0,c-2-0+1].concat(l=function(){var t,e,n;for(n=[],t=1,e=c;e>=1?e>=t:t>=e;e>=1?t++:t--)n.push(0);return n}())),l),e.data.forEach(function(t){o[new Date(t.date).getDate()-1]=t.counter}),a.isCurrentMonth()||(t.timelineCache[n]=o),r&&r(o),s.resolve()}}(this)),s.promise)},n.prototype.postText=function(n){var r;return r=e.defer(),void 0===n?(r.reject("Вы ничего не ввели"),r.promise):t.post("/texts",{text:n,date:Date.now(),counter:n.trim().split(/\s+/).length})},n}())}])}.call(this),function(){angular.module("users").controller("AuthenticationController",["$scope","$http","$location","$rootScope","AuthService",function(t,e,n,r,o){t.user=o.getUser(),t.user&&n.path("/"),t.signup=function(){return console.log("signup"),o.register(t.credentials).then(function(){return n.path("/today"),t.credentials={}},function(e){return t.error=e.message})},t.signin=function(){return o.login(t.credentials).then(function(){return n.path("/today"),t.credentials={}},function(e){return t.error=e.message})},t.logout=function(){return o.logout().then(function(){return n.path("/welcome")})}}])}.call(this),angular.module("users").controller("PasswordController",["$scope","$stateParams","$http","$location","AuthService",function(t,e,n,r,o){t.user=o.getUser(),t.user&&r.path("/"),t.askForPasswordReset=function(){t.success=t.error=null,n.post("/auth/forgot",t.credentials).success(function(e){t.credentials=null,t.success=e.message}).error(function(e){t.credentials=null,t.error=e.message})},t.resetUserPassword=function(){t.success=t.error=null,n.post("/auth/reset/"+e.token,t.passwordDetails).success(function(e){t.passwordDetails=null,o.setUser(e),r.path("/password/reset/success")}).error(function(e){t.error=e.message})}}]),angular.module("users").controller("SettingsController",["$scope","$http","$location","Users","AuthService",function(t,e,n,r,o){t.user=o.getUser(),t.user||n.path("/"),t.hasConnectedAdditionalSocialAccounts=function(e){for(var n in t.user.additionalProvidersData)return!0;return!1},t.isConnectedSocialAccount=function(e){return t.user.provider===e||t.user.additionalProvidersData&&t.user.additionalProvidersData[e]},t.removeUserSocialAccount=function(n){t.success=t.error=null,e["delete"]("/users/accounts",{params:{provider:n}}).success(function(e){t.success=!0,t.user=e}).error(function(e){t.error=e.message})},t.updateUserProfile=function(e){if(e){t.success=t.error=null;var n=new r(t.user);n.$update(function(e){t.success=!0,o.setUser(e)},function(e){t.error=e.data.message})}else t.submitted=!0},t.changeUserPassword=function(){t.success=t.error=null,e.post("/users/password",t.passwordDetails).success(function(e){t.success=!0,t.passwordDetails=null}).error(function(e){t.error=e.message})}}]),angular.module("users").config(["$httpProvider",function(t){t.interceptors.push(["$q","$location","Authentication",function(t,e,n){return{responseError:function(r){switch(r.status){case 401:n.logout(),e.path("signin");break;case 403:}return t.reject(r)}}}])}]),function(){angular.module("users").config(["$stateProvider",function(t){t.state("profile",{url:"/settings/profile",templateUrl:"modules/users/views/settings/edit-profile.client.view.html",access:{restricted:!0}}).state("password",{url:"/settings/password",templateUrl:"modules/users/views/settings/change-password.client.view.html",access:{restricted:!0}}).state("accounts",{url:"/settings/accounts",templateUrl:"modules/users/views/settings/social-accounts.client.view.html",access:{restricted:!0}}).state("signup",{url:"/signup",templateUrl:"modules/users/views/authentication/signup.client.view.html",access:{restricted:!1}}).state("signin",{url:"/signin",templateUrl:"modules/users/views/authentication/signin.client.view.html",access:{restricted:!1}}).state("forgot",{url:"/password/forgot",templateUrl:"modules/users/views/password/forgot-password.client.view.html",access:{restricted:!1}}).state("reset-invalid",{url:"/password/reset/invalid",templateUrl:"modules/users/views/password/reset-password-invalid.client.view.html",access:{restricted:!1}}).state("reset-success",{url:"/password/reset/success",templateUrl:"modules/users/views/password/reset-password-success.client.view.html",access:{restricted:!1}}).state("reset",{url:"/password/reset/:token",templateUrl:"modules/users/views/password/reset-password.client.view.html",access:{restricted:!1}})}]).run(["$rootScope","$location","AuthService",function(t,e,n){return t.$on("$stateChangeStart",function(r,o,i){return o.access.restricted&&n.isLoggedIn()===!1?(t.returnToState=o.url,t.returnToStateParams=i.Id,e.path("/login")):void 0})}])}.call(this),function(){angular.module("users").factory("AuthService",["$q","$timeout","$http","$window",function(t,e,n,r){var o,i,s,u,a,c,l,h,d,g,f;return r.user=null,o=function(t){return JSON.parse(r.atob(t.split(".")[1]))},g=function(t){return r.localStorage.token=t},i=function(){return r.localStorage.token},d=function(){return delete r.localStorage.token},a=function(){var t,e;return e=this.getToken(),e?(t=o(e),new Date(t.loginExpires)>Date.now()):!1},u=function(){var t,e;return this.isLoggedIn()?(e=this.getToken(),t=o(e),t.username):void 0},s=function(){return this.isLoggedIn()?r.user:void 0},f=function(t){return r.user=t},c=function(e){var o;return o=t.defer(),n.post("/auth/signin",e).success(function(t){return function(e,n){200===n&&e.loginToken?(r.user=e,t.saveToken(e.loginToken),o.resolve()):(r.user=!1,t.removeToken(),o.reject(e))}}(this)).error(function(t){return function(e){r.user=!1,t.removeToken(),o.reject(e)}}(this)),o.promise},l=function(){var e;return e=t.defer(),n.get("/auth/signout").success(function(t){return function(n){return r.user=!1,t.removeToken(),e.resolve()}}(this)).error(function(t){return r.user=!1,this.removeToken(),e.reject()}),e.promise},h=function(e){var r;return r=t.defer(),n.post("/auth/signup",e).success(function(t){return function(e,n){200===n&&e.loginToken?(t.saveToken(e.loginToken),r.resolve()):r.reject()}}(this)).error(function(t){return r.reject(t)}),r.promise},{isLoggedIn:a,getUser:s,login:c,logout:l,register:h,saveToken:g,getToken:i,getUserFromToken:u,removeToken:d}}])}.call(this),angular.module("users").factory("Authentication",[function(){var t=this;return t._data={user:window.user},t._data}]),angular.module("users").factory("Users",["$resource",function(t){return t("users",{},{update:{method:"PUT"}})}]),function(){angular.module("texts").factory("AlertService",["$timeout","$rootScope",function(t,e){var n;return new(n=function(){function n(){e.alerts=[]}return n.prototype.send=function(n,r,o,i){e.alerts.push({type:n,title:r,msg:o,close:function(t){return function(){return t.closeAlert(t)}}(this)}),"undefined"==typeof i&&(i=7e3),i&&t(function(t){return function(){t.closeAlert(t)}}(this),i)},n.prototype.closeAlert=function(t){return this.closeAlertIdx(e.alerts.indexOf(t))},n.prototype.closeAlertIdx=function(t){return e.alerts.splice(t,1)},n}())}])}.call(this),function(){angular.module("texts").directive("alerts",[function(){return{templateUrl:"modules/texts/directives/alerts/alerts.client.view.html",restrict:"E"}}])}.call(this),function(){angular.module("texts").controller("CallbackController",["$scope","AuthService","$http",function(t,e,n){t.user=e.getUser(),t.preventClose=function(t){return t.stopPropagation()},t.send_callback=function(){return n.post("/callback",{callback_text:t.callback_text})}}])}.call(this),function(){angular.module("texts").controller("HeaderController",["$scope","AuthService","Menus",function(t,e,n){return t.user=e.getUser(),t.isCollapsed=!1,t.menu=n.getMenu("topbar"),t.toggleCollapsibleMenu=function(){t.isCollapsed=!t.isCollapsed},t.$on("$stateChangeSuccess",function(){t.isCollapsed=!1})}])}.call(this),function(){angular.module("texts").directive("sooHeader",[function(){return{templateUrl:"modules/texts/directives/header/header.client.view.html",restrict:"E",controller:"HeaderController",scope:{}}}])}.call(this),function(){angular.module("texts").controller("TextController",["$scope","$http","$stateParams","$location","AuthService","$document","AlertService","WebApiService","TimelineService","DateService",function(t,e,n,r,o,i,s,u,a,c){t.user=o.getUser(),t.history={},t.todayDateString=c.getTodayString(),t.getWordCounter=function(){return t.text&&t.text.trim()?t.text.trim().split(/[\s,.;]+/).length:0},t.changed=!1,t.$watch("text",function(e,n){t.changed=e!==n&&void 0!==n,t.changed&&(t.state="notsaved",a.setCounterValue(c.getToday(),t.getWordCounter()))}),t.insertText=function(){return u.getToday().then(function(e){return t.text=e.data.text,t.state="saved",setInterval(t.save,1e4)},function(t){})},t.historyText="",t.state="saved",t.saveByKeys=function(e){return e.preventDefault(),e.stopPropagation(),t.changed&&void 0!==t.text?(t.state="saving",u.postText(t.text).then(function(e){return e.data.message?(s.send("danger",e.data.message,3e3),void(t.state="notsaved")):(s.send("success","Продолжайте!","Сохранение прошло успешно!",2e3),t.state="saved",t.changed=!1)},function(e){return s.send("danger","Упс!",e,4e3),t.state="notsaved"})):s.send("success","Продолжайте!","Ничего не изменилось с прошлого сохранения!",2e3),!1},t.putTab=function(e){var n,r;return e.preventDefault(),r=e.target.selectionStart,n=e.target.selectionEnd,t.text=t.text.substring(0,r)+"	"+t.text.substring(n),angular.element(e.target).val(t.text),e.target.selectionStart=e.target.selectionEnd=r+1},t.save=function(){return t.changed&&""!==t.text?(t.state="saving",u.postText(t.text).then(function(e){return e.data.message?void s.send("danger",e.message,3e3):(t.state="saved",t.changed=!1)},function(t){return s.send("danger","Упс!",t,4e3)})):void 0},t.showText=function(n){if(t.current_date.setHours(0,0,0,0)>new Date(t.curMonth+"-"+n).setHours(0,0,0,0))n+="",n=2===n.length?n:"0"+n,t.hideToday=!0,t.curDate=new Date(t.curMonth+"-"+n),e.get("/text/"+t.curMonth+"-"+n).success(function(e,n,r){t.historyText=e.text});else{if(t.current_date.setHours(0,0,0,0)!==new Date(t.curMonth+"-"+n).setHours(0,0,0,0))return void s.send("info","Машину времени пока изобретаем","Давайте жить сегодняшним днем!",3e3);t.hideToday=!1,t.historyText="",t.curDate=t.current_date}},t.$watch(function(){return a.workingDate},function(e,n){return e!==t.todayDateString?u.getText(e).then(function(n){return t.history.text=n.data.text,t.history.date=e},function(t){}):t.history={}})}])}.call(this),function(){angular.module("texts").directive("text",["TimelineService","AlertService","DateService","$stateParams",function(t,e,n,r){return{templateUrl:"modules/texts/directives/text/text.client.view.html",restrict:"E",controller:"TextController",link:function(t,e,n){r.date?t.insertText(r.date):t.insertText("today")}}}])}.call(this),function(){angular.module("texts").controller("TimelineController",["$scope","TimelineService","AuthService",function(t,e,n){return t.timeline={},e.fetchTimeline().then(function(){return t.timeline.days=e.timeline,t.timeline.languageMonth=e.monthLocaleString}),t.timeline_button_class=function(n,r){var o;return o="","--"===n&&(o="btn-default"),0===n&&(o="btn-info"),n>=500&&(o="btn-danger"),n>0&&500>n&&(o="btn-success"),e.getWorkingDate()===t.get_date_string(r)&&(o+=" active"),o},t.show_next_month=function(){return e.workingMonthIsLessThenCurrentMonth()},t.get_date_string=function(t){return t=t.toString(),e.getWorkingMonth()+"-"+(2===t.length?t:"0"+t)},t.changeMonth=function(n){switch(n){case"prev":e.prevmonth();break;case"next":e.nextmonth()}return e.fetchTimeline().then(function(){return t.timeline.days=e.timeline,t.timeline.languageMonth=e.monthLocaleString})},t.goToHistory=function(t){return e.setWorkingDate(t)}}])}.call(this),function(){angular.module("texts").directive("timeline",[function(){return{templateUrl:"modules/texts/directives/timeline/timeline.client.view.html",restrict:"E",scope:{},controller:"TimelineController"}}])}.call(this),function(){angular.module("texts").factory("TimelineService",["WebApiService","DateService","$locale",function(t,e,n){var r;return new(r=function(){function r(){this.workingMonth=e.getTodayMonthString(),this.workingDate=e.getTodayString(),this.monthLocaleString=this.getMonthLocaleString()}return r.prototype.workingMonth="",r.prototype.workingDate="",r.prototype.timeline=[],r.prototype.monthLocaleString="",r.prototype.fetchTimeline=function(){return t.fetchTimeline(this.workingMonth,function(t){return function(e){return angular.copy(e,t.timeline)}}(this))},r.prototype.setCounterValue=function(t,e){return t.yyyymm()===this.workingMonth?this.timeline[t.getDate()-1]=e:void 0},r.prototype.setWorkingMonth=function(t){return this.workingMonth=t,this.updateMonthLocaleString()},r.prototype.getWorkingMonth=function(){return this.workingMonth},r.prototype.setWorkingDate=function(t){return this.workingDate=t},r.prototype.getWorkingDate=function(){return this.workingDate},r.prototype.prevmonth=function(){return this.workingMonth=e.prevMonthString(new Date(this.workingMonth)),this.monthLocaleString=this.getMonthLocaleString()},r.prototype.nextmonth=function(){return this.workingMonth=e.nextMonthString(new Date(this.workingMonth)),this.monthLocaleString=this.getMonthLocaleString()},r.prototype.workingMonthIsLessThenCurrentMonth=function(){return Date.parse(new Date(this.workingMonth))<Date.parse(e.getTodayMonthString())},r.prototype.getMonthLocaleString=function(){return n.DATETIME_FORMATS.STANDALONEMONTH[+this.workingMonth.slice(5,7)-1]+" "+this.workingMonth.slice(0,4)},r}())}])}.call(this),function(){angular.module("texts").controller("todayCtrl",function(){return console.log("todayCtrl")})}.call(this);